name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  lint:
    name: Lint Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install shellcheck
        run: sudo apt-get install -y shellcheck

      - name: Lint shell scripts
        run: |
          echo "Running shellcheck on all scripts..."
          find scripts -name "*.sh" -exec shellcheck -x {} \;
          echo "All scripts passed shellcheck"

      - name: Validate action.yml
        run: |
          echo "Validating action.yml syntax..."
          python3 -c "import yaml; yaml.safe_load(open('action.yml'))"
          echo "action.yml is valid"

  test:
    name: Test Action
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Check for API key
        id: check
        run: |
          if [[ -n "${{ secrets.ELEVENLABS_API_KEY }}" ]]; then
            echo "has_key=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_key=false" >> "$GITHUB_OUTPUT"
            echo "::warning::ELEVENLABS_API_KEY secret not set - skipping integration tests"
          fi

      - name: Test TTS operation
        if: steps.check.outputs.has_key == 'true'
        uses: ./
        with:
          operation: tts
          api-key: ${{ secrets.ELEVENLABS_API_KEY }}
          text: "Hello from the ElevenLabs CLI GitHub Action test!"
          voice: Brian
          output: test-output/hello.mp3
          verbose: "true"

      - name: Verify TTS output
        if: steps.check.outputs.has_key == 'true'
        run: |
          if [[ -f "test-output/hello.mp3" ]]; then
            echo "TTS output file created successfully"
            ls -la test-output/
          else
            echo "TTS output file not found"
            exit 1
          fi

      - name: Test Usage operation
        if: steps.check.outputs.has_key == 'true'
        uses: ./
        with:
          operation: usage
          api-key: ${{ secrets.ELEVENLABS_API_KEY }}
          usage-threshold: 90
